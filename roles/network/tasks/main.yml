---
# 1. VPC 생성
- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ prefix }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ region }}"
    dns_hostnames: yes 
    dns_support: yes
    state: present
  register: vpc_result

# 2. 기존 NAT Gateway가 존재하면 제거(추가)
- name: Get existing NAT Gateway info
  amazon.aws.ec2_vpc_nat_gateway_info:
    region: "{{ region }}"
    filters:
      "tag:Name": "{{ prefix }}-nat-gw"
      state: ['available', 'pending']
  register: existing_nat_info

- name: Delete existing NAT Gateway
  amazon.aws.ec2_vpc_nat_gateway:
    region: "{{ region }}"
    nat_gateway_id: "{{ item.nat_gateway_id }}"
    state: absent
    wait: yes
    wait_timeout: 600
  loop: "{{ existing_nat_info.nat_gateways }}"
  when: existing_nat_info.nat_gateways | length > 0  

# 3. 기존 NAT EIP 해제 및 제거 (추가)
- name: Get existing EIP info
  amazon.aws.ec2_eip_info:
    region: "{{ region }}"
    filters:
      "tag:Name": "{{ prefix }}-nat-eip"
  register: existing_eip_info

- name: Release existing EIP
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    allocation_id: "{{ item.allocation_id }}"
    state: absent
  loop: "{{ existing_eip_info.addresses }}"
  when: existing_eip_info.addresses | length > 0

# 4. 인터넷 게이트웨이(IGW) 생성
- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    state: present
    tags:
      Name: "{{ prefix }}-igw"
  register: igw_result

# 5. 서브넷 생성
- name: Create Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    az: "{{ item.az }}"
    cidr: "{{ item.cidr }}"
    map_public: "{{ item.public }}" 
    state: present
    tags:
      Name: "{{ prefix }}-{{ item.name }}"
  loop: "{{ subnet_list }}"
  register: subnet_results

# 6. NAT Gateway용 탄력적 IP(EIP) 할당
- name: Allocate EIP for NAT Gateway
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-nat-eip"
    state: present
  register: nat_eip

# 7. NAT Gateway 생성 (이름 태그 및 대기 설정)
- name: Create NEW NAT Gateway
  amazon.aws.ec2_vpc_nat_gateway:
    region: "{{ region }}"
    subnet_id: "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | first).subnet.id }}"
    allocation_id: "{{ nat_eip.allocation_id }}"
    wait: yes 
    tags:
      Name: "{{ prefix }}-nat-gw"
    state: present
  register: new_nat_gw

# 8. [중요] 최신 리소스 정보 조회
- name: Get VPC Info
  amazon.aws.ec2_vpc_net_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-vpc" }
  register: vpc_info

- name: Get IGW Info
  amazon.aws.ec2_vpc_igw_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-igw" }
  register: igw_info

- name: Get NAT GW Info
  amazon.aws.ec2_vpc_nat_gateway_info:
    region: "{{ region }}"
    filters: 
      "tag:Name": "{{ prefix }}-nat-gw"
      state: ['available', 'pending']
  register: nat_info

- name: Get Subnet Info
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ region }}"
    filters: { vpc-id: "{{ vpc_info.vpcs[0].vpc_id }}" }
  register: subnet_info

# 7. 퍼블릭 라우팅 테이블 생성 및 명시적 연결
- name: Create Public Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-pub-rt"
    # [수정] 이름에 'pub'이 들어간 서브넷 ID를 명시적으로 리스트화하여 연결
    subnets: "{{ subnet_info.subnets | selectattr('tags.Name', 'search', 'pub') | map(attribute='id') | list }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ igw_info.internet_gateways[0].internet_gateway_id }}"

# 8. 프라이빗 라우팅 테이블 생성 및 명시적 연결
- name: Create Private Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-priv-rt"
    # [수정] 이름에 'priv'이 들어간 서브넷 ID를 명시적으로 연결하여 NAT 경로를 타게 합니다.
    subnets: "{{ subnet_info.subnets | selectattr('tags.Name', 'search', 'priv') | map(attribute='id') | list }}"
    routes:
      - dest: 0.0.0.0/0
        # available 상태인 NAT GW ID를 안전하게 가져옵니다.
        nat_gateway_id: >-
          {{ 
            new_nat_gw.nat_gateway_id if (new_nat_gw.nat_gateway_id is defined) 
            else (nat_info.nat_gateways | selectattr('state', 'equalto', 'available') | list | first | default({'nat_gateway_id': ''})).nat_gateway_id 
          }}
  when: (new_nat_gw.nat_gateway_id is defined) or (nat_info.nat_gateways | length > 0)