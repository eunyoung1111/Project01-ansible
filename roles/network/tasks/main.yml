---
# 1. VPC 생성
- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ prefix }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ region }}"
    dns_hostnames: yes  # 퍼블릭 DNS를 갖게함
    dns_support: yes
    state: present
  register: vpc_result

# 2. 기존 자원 제거(NAT GW, EIP) - 충돌반지, 멱등성 보장
- name: Get existing NAT Gateway info
  amazon.aws.ec2_vpc_nat_gateway_info:
    region: "{{ region }}"
    filters:
      "tag:Name": "{{ prefix }}-nat-gw"
      state: ['available', 'pending']
  register: existing_nat_info

- name: Delete existing NAT Gateway
  amazon.aws.ec2_vpc_nat_gateway:
    region: "{{ region }}"
    nat_gateway_id: "{{ item.nat_gateway_id }}"
    state: absent
    wait: yes
    wait_timeout: 600
  loop: "{{ existing_nat_info.nat_gateways }}"
  when: existing_nat_info.nat_gateways | length > 0  

- name: Get existing EIP info
  amazon.aws.ec2_eip_info:
    region: "{{ region }}"
    filters:
      "tag:Name": "{{ prefix }}-nat-eip"
  register: existing_eip_info

- name: Release existing EIP
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    allocation_id: "{{ item.allocation_id }}"
    state: absent
  loop: "{{ existing_eip_info.addresses }}"
  when: existing_eip_info.addresses | length > 0

# 3. 인터넷 게이트웨이(IGW) 생성
- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    state: present
    tags:
      Name: "{{ prefix }}-igw"
  register: igw_result

# 4. 서브넷 생성 - pub2, priv2
- name: Create Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id }}"
    region: "{{ region }}"
    az: "{{ item.az }}"
    cidr: "{{ item.cidr }}"
    map_public: "{{ item.public }}" 
    state: present
    tags:
      Name: "{{ prefix }}-{{ item.name }}"
  loop: "{{ subnet_list }}"
  register: subnet_results

# 5. EIP 할당 - NAT GW가 외부로 나갈떄 사용할 '전용 고정 IP'
- name: Allocate EIP for NAT Gateway
  amazon.aws.ec2_eip:
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-nat-eip"
    state: present
  register: nat_eip

# 6. NAT GW 생성
- name: Create NEW NAT Gateway
  amazon.aws.ec2_vpc_nat_gateway:
    region: "{{ region }}"
    # 'pub-a'에 설치
    subnet_id: "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | first).subnet.id }}"
    allocation_id: "{{ nat_eip.allocation_id }}"
    wait: yes 
    tags:
      Name: "{{ prefix }}-nat-gw"
    state: present
  register: new_nat_gw

# 7. RT생성을 위한 최신 리소스 정보 조회
- name: Get VPC Info
  amazon.aws.ec2_vpc_net_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-vpc" }
  register: vpc_info

- name: Get IGW Info
  amazon.aws.ec2_vpc_igw_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-igw" }
  register: igw_info

- name: Get NAT GW Info
  amazon.aws.ec2_vpc_nat_gateway_info:
    region: "{{ region }}"
    filters: 
      "tag:Name": "{{ prefix }}-nat-gw"
      state: ['available', 'pending']
  register: nat_info

- name: Get Subnet Info
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ region }}"
    filters: { vpc-id: "{{ vpc_info.vpcs[0].vpc_id }}" }
  register: subnet_info

# 8. 퍼블릭RT 생성: 모든 트래픽(0.0.0.0/0)을 IGW로 보냄냄
- name: Create Public Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-pub-rt"
    # pub 서브넷 명시적으로 연결
    subnets: "{{ subnet_info.subnets | selectattr('tags.Name', 'search', 'pub') | map(attribute='id') | list }}"
    routes:
      - dest: 0.0.0.0/0 # 모든 외부 목적지
        gateway_id: "{{ igw_info.internet_gateways[0].internet_gateway_id }}"

# 9. 프라이빗RT 생성: 모든 트래픽을 NAT GW로 보냄
- name: Create Private Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    tags:
      Name: "{{ prefix }}-priv-rt"
    # priv 서브넷 명시적 연결
    subnets: "{{ subnet_info.subnets | selectattr('tags.Name', 'search', 'priv') | map(attribute='id') | list }}"
    routes:
      - dest: 0.0.0.0/0
        nat_gateway_id: >-
          {{ 
            new_nat_gw.nat_gateway_id if (new_nat_gw.nat_gateway_id is defined) 
            else (nat_info.nat_gateways | selectattr('state', 'equalto', 'available') | list | first | default({'nat_gateway_id': ''})).nat_gateway_id 
          }}
  when: (new_nat_gw.nat_gateway_id is defined) or (nat_info.nat_gateways | length > 0)
