---
# 1. VPC 정보 조회
- name: Get VPC info
  amazon.aws.ec2_vpc_net_info:
    region: "{{ region }}"
    filters: { "tag:Name": "{{ prefix }}-vpc" }
  register: vpc_info

# 2. 젠킨스 인스턴스 정보 조회
- name: Get Info for Jenkins Instance
  amazon.aws.ec2_instance_info:
    region: "{{ region }}"
    filters:
      "tag:Name": "{{ prefix }}-jenkins"
      instance-state-name: ["running"]
  register: jenkins_info

# 3. 젠킨스용 대상 그룹 생성
- name: Create Jenkins Target Group
  community.aws.elb_target_group:
    name: "{{ prefix }}-jenkins-tg"
    protocol: http
    port: 8080
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    health_check_path: /jenkins/login
    health_check_protocol: HTTP
    targets:
      - Id: "{{ jenkins_info.instances[0].instance_id }}"
    state: present
  register: jenkins_tg

# 4. WAS용 대상 그룹 생성
- name: Create WAS Target Group
  community.aws.elb_target_group:
    name: "{{ prefix }}-was-tg"
    protocol: http
    port: 8080
    vpc_id: "{{ vpc_info.vpcs[0].vpc_id }}"
    region: "{{ region }}"
    health_check_path: /
    health_check_protocol: HTTP
    state: present
  register: was_tg

# # 5. [수정] ALB 생성 (기본 리스너만 정의)
# - name: Create Application Load Balancer
#   amazon.aws.elb_application_lb: # 더 안정적인 amazon.aws 모듈 사용 권장
#     name: "{{ prefix }}-alb"
#     security_groups: ["{{ alb_sg_id }}"]
#     subnets:
#       - "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | first).subnet.id }}"
#       - "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-c') | first).subnet.id }}"
#     region: "{{ region }}"
#     listeners:
#       - Protocol: HTTP
#         Port: 80
#         DefaultActions:
#           - Type: forward
#             TargetGroupArn: "{{ was_tg.target_group_arn }}"
#     state: present
#   register: alb_result

# 5. [통합] ALB 생성 및 리스너 규칙을 한꺼번에 정의
- name: Create ALB with Path Rules
  amazon.aws.elb_application_lb:
    name: "{{ prefix }}-alb"
    security_groups: ["{{ alb_sg_id }}"]
    subnets:
      - "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-a') | first).subnet.id }}"
      - "{{ (subnet_results.results | selectattr('item.name', 'equalto', 'pub-c') | first).subnet.id }}"
    region: "{{ region }}"
    listeners:
      - Protocol: HTTP
        Port: 80
        DefaultActions:
          - Type: forward
            TargetGroupArn: "{{ was_tg.target_group_arn }}"
        # [핵심] 별도 모듈 대신 여기서 Rules를 정의합니다.
        Rules:
          - Priority: 1
            Conditions:
              - Field: path-pattern
                Values: ['/jenkins*']
            Actions:
              - Type: forward
                TargetGroupArn: "{{ jenkins_tg.target_group_arn }}"
    state: present
  register: alb_result