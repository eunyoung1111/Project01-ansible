---
# 1. 최신 Amazon Linux 2023 AMI ID 조회
- name: Find Latest Amazon Linux 2023 AMI
  amazon.aws.ec2_ami_info:
    owners: ["137112412989"]
    filters:
      name: "al2023-ami-2023.*-x86_64"
    region: "{{ region }}"
  register: al2023_ami

# 2. WAS용 보안 그룹 ID 조회
- name: Get WAS Security Group info
  amazon.aws.ec2_security_group_info:
    region: "{{ region }}"
    filters:
      group-name: "{{ prefix }}-target-sg"
  register: was_sg_info

# 3. WAS용 대상 그룹 ARN 조회
- name: Get WAS Target Group info
  community.aws.elb_target_group_info:
    region: "{{ region }}"
    names:
      - "{{ prefix }}-was-tg" # 이 이름이 콘솔의 이름과 정확히 일치해야 합니다!
  register: was_tg_info

# [추가] 조회 결과가 비었는지 확인하기 위한 디버그 태스크
- name: Debug WAS Target Group Info
  debug:
    msg: "조회된 대상 그룹: {{ was_tg_info.target_groups }}"

- name: Check if WAS Target Group exists
  ansible.builtin.fail:
    msg: "대상 그룹 '{{ prefix }}-was-tg'를 찾을 수 없습니다. 이름을 확인하세요."
  when: was_tg_info.target_groups | length == 0

# 4. 프라이빗 서브넷 정보 조회
- name: Get Private Subnet info for ASG
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ region }}"
    filters:
      "tag:Name": ["{{ prefix }}-priv-a", "{{ prefix }}-priv-c"]
  register: priv_subnets

# 5. 시작 템플릿(Launch Template) 생성
- name: Create Launch Template
  amazon.aws.ec2_launch_template:
    name: "{{ prefix }}-template"
    # ... 중략 ...
    # 수정: 'template' 파일이 아니라 아래 정의한 'string' 변수를 가져오도록 변경
    user_data: "{{ user_data_script | b64encode }}" 
    region: "{{ region }}"
    state: present
  vars:
    user_data_script: |
      #!/bin/bash
      # 1. Amazon Linux 2023 도커 설치
      dnf update -y
      dnf install -y docker
      systemctl start docker
      systemctl enable docker
      usermod -aG docker ec2-user

      # 2. 도커 컴포즈 V2 플러그인 설치 (이게 핵심!)
      mkdir -p /usr/local/lib/docker/cli-plugins
      curl -SL https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
      chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

      # 3. 경로 심볼릭 링크
      ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
      ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker
      
      # 4. CodeDeploy 에이전트 설치 (기존에 있던 내용도 포함시켜야 함!)
      dnf install -y ruby wget
      cd /home/ec2-user
      wget https://aws-codedeploy-ap-northeast-2.s3.ap-northeast-2.amazonaws.com/latest/install
      chmod +x ./install
      ./install auto
      
# 6. 오토스케일링 그룹(ASG) 생성 (문법 및 이름 교정)
- name: Create Auto Scaling Group
  amazon.aws.autoscaling_group:
    # [중요] cleanup.yml에서 지울 이름과 정확히 일치시켜야 합니다.
    name: "{{ prefix }}-was-asg" 
    launch_template:
      launch_template_name: "{{ prefix }}-template"
      version: "$Latest"
    min_size: 1
    max_size: 3
    desired_capacity: 1
    vpc_zone_identifier: "{{ priv_subnets.subnets | map(attribute='id') | list }}"
    target_group_arns: "{{ was_tg_info.target_groups | map(attribute='target_group_arn') | list }}"
    health_check_type: EC2 
    health_check_period: 300
    region: "{{ region }}"
    state: present
    wait_for_instances: no
    # [교정] 태그는 반드시 모듈 설정 내부에 포함되어야 합니다.
    tags:
      - Key: Name
        Value: "{{ prefix }}-app"
        PropagateAtLaunch: true